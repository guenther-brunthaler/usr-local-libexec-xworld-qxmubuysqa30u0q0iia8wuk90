#! /bin/sh
# Add to your $HOME/.bazaar/bazaar.conf to section:
# [DEFAULT]
# the line:
# editor = /usr/local/libexec/xworld/bzr-joe-editor
#
# This can also be done with the following command:
# $ sed -ie '/^\[DEFAULT]$/a editor = /usr/local/libexec/xworld/bzr-joe-editor' ~/.bazaar/bazaar.conf
set -e
cleanup() {
	test -n "$t" && rm -- "$t"
	test -n "$t2" && rm -- "$t2"
	test -n "$OK" || echo 'Failed!' >& 2
}
notext() {
	echo "No text was entered... aborting." >& 2
	# bzr mis-iterprets any error exit code as a failure to start the
	# editor. Therefore exiting normally.
	exit
}
t=
OK=
trap cleanup 0
test x"$#" = x1
t=`tempfile -p bzrci -s .msg`
{
	cat
	sed -e '1,/^-----/ d' "$1"
} <<- 'EOF' > "$t"
#Headline is capitalized and not longer than this:
##################################################

########################################################################
#Body text lines should not be longer than the line before this one.
#Write your commit message in the imperative: "Fix bug" and not "Fixed
#bug" or "Fixes bug". This is consistent with autogenerated entries.
#
#All '#'-commented-out lines like this one will be removed from the log
#message, as well as all lines following the next line.
#                       [END-OF-TEXT marker: rbt1ffsagr1qrfb1519dfi80i]
EOF
l=`locale | sed -e 's,^LANG=,,; t; d'`
cs=${l##*.}
test -x"$cs" != x"$l" || cs=
l=en_US.${cs:-utf8}
t2=`tempfile -p bzrci -s .tmp`
cat -- "$t" > "$t2"
joe -language "$l" -rmargin 73 -wordwrap -- +3 "$t"
cmp -- "$t" "$t2" > /dev/null && notext
ws=`printf '[ \t]'`
sed -e "/rbt1ffsagr1qrfb1519dfi80i/,\$ d; s/$ws\\+\$//" "$t" \
| sed -e '/^#/ d' > "$t2"
grep -v '^$' "$t2" > /dev/null || notext
cat "$t2" > "$1"
OK=Y
